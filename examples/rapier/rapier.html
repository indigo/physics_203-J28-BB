<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Demo Rapier.js 3D - Cube Tombant</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; }
        canvas { display: block; }
    </style>
</head>
<body>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/",
                "@dimforge/rapier3d-compat": "https://unpkg.com/@dimforge/rapier3d-compat@0.12/rapier.es.js",
                "lil-gui": "https://unpkg.com/lil-gui@0.20.0/dist/lil-gui.esm.min.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import RAPIER from '@dimforge/rapier3d-compat';
        import { GUI } from 'lil-gui';

        let camera, scene, renderer, controls, clock;
        let groundMesh_three, dynamicBoxMesh_three;
        let world_rapier, dynamicBoxBody_rapier;
        
        const simParams = {
            gravityY: -9.81,
            boxSize: 0.5,
            boxInitialY: 4.0,
            boxMass: 1.0,
            boxRestitution: 0.7,
            groundY: 0.0,
            groundSizeX: 10.0,
            groundSizeZ: 10.0,
            groundRestitution: 0.5,
            reset: function() { resetSimulation(); }
        };

        async function init() {
            // 1. Initialisation Rapier 3D
            try {
                await RAPIER.init();
                console.log("✅ Rapier 3D (WASM) chargé.");
            } catch (e) {
                console.error("❌ Erreur Rapier:", e);
                return;
            }

            // 2. Initialisation Three.js
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x202020);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(5, 5, 8); // Vue en diagonale pour bien voir la 3D

            const ambient = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
            scene.add(ambient);

            const light = new THREE.DirectionalLight(0xffffff, 2.0);
            light.position.set(5, 10, 7);
            light.castShadow = true;
            scene.add(light);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1, 0);
            controls.update();

            resetSimulation();
            setupGUI();

            window.addEventListener('resize', onWindowResize, false);
            renderer.setAnimationLoop(animate);
        }

        function createPhysicsWorld() {
            if (world_rapier) world_rapier.free();

            // CORRECTION 1: Gravité avec X, Y, Z
            const gravity = { x: 0.0, y: simParams.gravityY, z: 0.0 };
            world_rapier = new RAPIER.World(gravity);

            // --- SOL ---
            const groundDesc = RAPIER.RigidBodyDesc.fixed()
                .setTranslation(0.0, simParams.groundY, 0.0);
            const groundBody = world_rapier.createRigidBody(groundDesc);
            
            // CORRECTION 2: Cuboid prend (hx, hy, hz) en 3D
            const groundColliderDesc = RAPIER.ColliderDesc.cuboid(
                simParams.groundSizeX / 2, 
                0.1, 
                simParams.groundSizeZ / 2
            ).setRestitution(simParams.groundRestitution);
            world_rapier.createCollider(groundColliderDesc, groundBody);

            // --- BOITE ---
            // CORRECTION 3: setTranslation avec Z
            const bodyDesc = RAPIER.RigidBodyDesc.dynamic()
                .setTranslation(0.0, simParams.boxInitialY, 0.0)
                .setCanSleep(false);
            
            dynamicBoxBody_rapier = world_rapier.createRigidBody(bodyDesc);

            // CORRECTION 4: Cuboid avec Z
            const colliderDesc = RAPIER.ColliderDesc.cuboid(
                simParams.boxSize, 
                simParams.boxSize, 
                simParams.boxSize
            )
            .setRestitution(simParams.boxRestitution)
            .setMass(simParams.boxMass);
            world_rapier.createCollider(colliderDesc, dynamicBoxBody_rapier);
        }

        function createVisuals() {
            if (groundMesh_three) scene.remove(groundMesh_three);
            if (dynamicBoxMesh_three) scene.remove(dynamicBoxMesh_three);

            // Sol
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x445566, metalness: 0.2, roughness: 0.5 });
            const floorGeo = new THREE.BoxGeometry(simParams.groundSizeX, 0.2, simParams.groundSizeZ); // Boite visuelle au lieu de plane
            groundMesh_three = new THREE.Mesh(floorGeo, floorMat);
            groundMesh_three.position.y = simParams.groundY;
            groundMesh_three.receiveShadow = true;
            scene.add(groundMesh_three);

            // Boîte
            const boxGeo = new THREE.BoxGeometry(simParams.boxSize * 2, simParams.boxSize * 2, simParams.boxSize * 2);
            const boxMat = new THREE.MeshStandardMaterial({ color: 0xffaa00, metalness: 0.4, roughness: 0.2 });
            dynamicBoxMesh_three = new THREE.Mesh(boxGeo, boxMat);
            dynamicBoxMesh_three.castShadow = true;
            scene.add(dynamicBoxMesh_three);
        }

        function resetSimulation() {
            createPhysicsWorld();
            createVisuals();
        }

        function animate() {
            if (world_rapier && dynamicBoxMesh_three) {
                world_rapier.step();

                const pos = dynamicBoxBody_rapier.translation();
                const rot = dynamicBoxBody_rapier.rotation(); // Retourne un Quaternion {x,y,z,w} en 3D

                // CORRECTION 5: Synchronisation 3D
                dynamicBoxMesh_three.position.copy(pos);
                dynamicBoxMesh_three.quaternion.copy(rot);
            }

            controls.update();
            renderer.render(scene, camera);
        }

        function setupGUI() {
            const gui = new GUI({ title: "Paramètres" });
            gui.add(simParams, 'reset').name('♻️ Réinitialiser');

            const folderPhys = gui.addFolder('Physique');
            folderPhys.add(simParams, 'gravityY', -20.0, 0.0).onChange(resetSimulation);
            folderPhys.add(simParams, 'boxRestitution', 0.0, 1.2).onChange(resetSimulation);
            
            const folderScene = gui.addFolder('Scène');
            folderScene.add(simParams, 'boxSize', 0.1, 1.0).onChange(resetSimulation);
            folderScene.add(simParams, 'boxInitialY', 0.0, 10.0).onChange(resetSimulation);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>